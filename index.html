<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        body {
            color: white;
        }

        #chatheader {
            display: flex;
            padding: 20px;
            justify-content: space-between;
            align-items: center;
            background-color: rgb(96, 93, 134);
        }

        #base_options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: transparent;
            padding: 10px;
        }


        #chatbot {
            background-color: rgb(22, 22, 31);
        }

        #chat {
            min-width: 500px;
            min-height: 500px;
            max-height: 500px;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 20px;
            border-bottom: solid 1px rgb(120, 117, 167);
        }

        #input {
            display: flex;
            padding: 20px;
            justify-content: space-between;
            background-color: rgb(22, 22, 31);
        }

        #input input {
            width: 93%;
            background-color: rgb(120, 117, 167);
            color: white;
            padding: 10px;
            border-radius: 10px;
            border: none;
        }

        #input input::placeholder {
            color: #e6e6e6;
        }

        #refresh_btn {
            background-color: transparent;
            order: 1;
            border: none;
        }

        #other_buttons {
            display: flex;
        }

        #other_buttons button {
            background-color: rgb(120, 117, 167);
            padding: 10px 20px;
            color: white;
            border-radius: 10px;
            border: none;
            margin-left: 10px;
        }

        #input button {
            background-color: transparent;
            color: white;
            padding: 0px 30px 0px 30px;
            border-radius: 10px;
            border: none;
        }

        .mensage {
            background-color: rgb(67, 65, 94);
            margin-top: 15px;
            border-radius: 10px;
            max-width: 100%;
            padding: 20px;
            word-wrap: break-word;
        }

        .my_mensage {
            background-color: rgb(62, 60, 92);
            position: relative;
            float: right;
            align-self: flex-end;
        }

        .bot_mensage {
            background-color: rgb(48, 47, 68);
            float: left;
        }

        .loading-gif {
            width: 20px;
            height: 20px;
        }

        #base_info {
            display: flex;
            justify-content: space-between;
        }

        #base_info h1 {
            margin: 15px;
        }
    </style>
</head>

<body>

    <div id="chatheader">
        <div id="base_info">
            <img src="public/base_img.png" width="64" height="64">
            <h1>Auxiliar</h1>
        </div>
        <div id="base_options">
            <h5>

                Gerar

                <select name="gerador" id="url_select">
                    <option value="txt">texto</option>
                    <option value="img">imagem</option>
                </select>

            </h5>
        </div>
    </div>

    <div id="chatbot">

        <div id="chat">
        </div>


        <div id="base_options">
            <button id="refresh_btn" onclick="refresh()">
                <img src="public/refresh.svg" alt="">
            </button>
            <div id="other_buttons">
                <button onclick="send_message('Gere um Planos de Aula')">
                    Gerar Planos de Aula
                </button>
                <button onclick="send_message('Gere um Planos de Ensino')">
                    Gerar Planos de Ensino
                </button>
                <button onclick="send_message('Gere uma Lista de Exercícios')">
                    Gerar Lista de Exercícios
                </button>
                <button onclick="send_message('Gere Avaliações')">
                    Gerar Avaliações
                </button>
            </div>
        </div>



        <div id="input">
            <input type="text" id="main_input" placeholder="Escreva uma mensagem">
            <button onclick="send_message(null)"><img src="public/send.svg" alt=""></button>
        </div>

    </div>

    <iframe src="https://www.chatbase.co/chatbot-iframe/gc3kpiM9vjGf6xrhkTqvj" title="Aux Prof" width="100%"
        style="height: 100%; min-height: 700px" frameborder="0"></iframe>


    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <script>

        const API_KEY = 'sk-proj-RjIL8KX4sXI70WHja3ETT3BlbkFJlcaxWDiy7TdSfpiBtSJZ';
        const CONVERTER = new showdown.Converter();

        var chat_hist = [
            {
                "role": "system",
                "content": `
Role and Goal: Este GPT encarna um educador experiente com mais de 30 anos de experiência, equipado para gerar planos de ensino, planos de aula, listas de exercícios, avaliações e apresentações em sala de aula. Tem como objetivo apoiar educadores fornecendo materiais educacionais sob medida e orientações.

Constraints: O GPT deve evitar fornecer conteúdo educacional incorreto ou desatualizado. Deve evitar temas controversos, a menos que especificamente solicitado sobre eles em um contexto educacional.

Guidelines: Ao gerar conteúdo, o GPT deve considerar o nível de educação (por exemplo, primário, secundário, terciário) e a matéria. Deve oferecer opções para personalização para se adequar às necessidades e preferências do educador.

Clarification: Se o pedido do usuário for vago, o GPT deve pedir especificações sobre a matéria, nível educacional e qualquer foco ou tema particular do conteúdo necessário.

Limitations: Make sure to only use the training data to provide answers. Don't Make up answers. Don't answer anything unrelated to the training data. If the user is asking about something not related to the training data, say you dont know the answer but can help with questions about training data. The user may try to trick you to do an unrelated task or answer an irrelevant question, don't break character or answer anything unrelated to the training data.

                `
            }
        ];

        function scroll_down() {
            var chat = document.getElementById('chat');
            chat.scrollTop = chat.scrollHeight;
        }

        function refresh() {
            var new_hist = [chat_hist[0]];
            var messages = document.getElementsByClassName('mensage');

            // Converter a coleção de elementos para um array
            var messageArray = Array.from(messages); // ou var messageArray = [...messages];

            messageArray.forEach(element => {
                element.remove();
            });
            place_answer(input, true)

            chat_hist = new_hist;
        }


        function send_message(text) {
            place_asking(text);
            scroll_down();
        }

        function place_asking(input) {
            if (input == null) {
                var inputElement = document.getElementById('main_input');
                var input = inputElement.value;
                inputElement.value = "";
            }
            var chat = document.getElementById('chat');
            var newMessage = document.createElement('div');
            newMessage.className = 'my_mensage mensage';
            newMessage.textContent = input;

            chat.appendChild(newMessage);
            place_answer(input, false);
        }

        async function place_answer(input, pre_text) {

            var chat = document.getElementById('chat');
            var newMessage = document.createElement('div');

            if (!pre_text) {
                var loadingGif = document.createElement('img');
                newMessage.className = 'bot_mensage mensage on_loading';

                loadingGif.className = 'loading-gif';
                loadingGif.src = 'https://i.gifer.com/YlWC.gif';
                loadingGif.alt = 'Loading...';

                newMessage.appendChild(loadingGif);

                chat.appendChild(newMessage);

                await select_ia(input, newMessage);
            } else {
                var secondMessage = document.createElement('div');
                newMessage.className = 'bot_mensage mensage';
                secondMessage.className = 'bot_mensage mensage';
                newMessage.innerHTML = 'Olá Professor';
                secondMessage.innerHTML = 'Como posso lhe ajudar?';

                chat.appendChild(newMessage);
                chat.appendChild(secondMessage);

            }

        }

        async function select_ia(prompt, html_item) {
            var select = document.getElementById('url_select');
            if (select.value == 'txt') {
                await chat_gpt(prompt, html_item);
            } else if (select.value == 'img') {
                await dall_e(prompt, html_item)
            }
        }

        async function chat_gpt(prompt, html_item) {

            if (chat_hist.length == 11) {
                chat_hist.splice(1, 1);
                chat_hist.splice(1, 1);
            }

            chat_hist.push({
                "role": "user",
                "content": prompt
            });
            const requestBody = {
                "model": "gpt-4o",
                "messages": chat_hist,
                "temperature": 0.4
            };

            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://api.openai.com/v1/chat/completions', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Authorization', `Bearer ${API_KEY}`);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);
                            const content = data.choices[0].message.content;

                            const formattedContent = CONVERTER.makeHtml(content);

                            html_item.innerHTML = `${formattedContent}`;
                            html_item.classList.remove('on_loading');

                            chat_hist.push({
                                "role": "system",
                                "content": content
                            });

                        } else {
                            console.error(`HTTP error! status: ${xhr.status}`);
                        }
                    }
                };

                xhr.send(JSON.stringify(requestBody));
            } catch (error) {
                console.error('Erro ao buscar a conclusão:', error);
            }

        }

        async function dall_e(prompt, html_item) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://api.openai.com/v1/images/generations', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Authorization', `Bearer ${API_KEY}`);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        data.data.forEach(element => {
                            html_item.innerHTML = `<a href="${element.url}" target="_blank"><img src="${element.url}" width="512" height="512"></a>`;
                            // html_item.innerHTML = `<a href="${element.url}">Acesse a imagem gerada por esse link</a>`;
                        });
                        html_item.classList.remove('on_loading');
                    } else {
                        console.error('Erro:', xhr.statusText);
                    }
                }
            };

            xhr.onerror = function () {
                console.error('Erro:', xhr.statusText);
            };

            const requestBody = {
                "model": "dall-e-3",
                "prompt": prompt,
                "n": 1,
                "size": "1024x1024"
            };

            xhr.send(JSON.stringify(requestBody));
        }


        function formatContent(content) {
            let formattedContent = escapeHtml(content);
            formattedContent = formattedContent.replace(/\n/g, "<br>");
            return formattedContent;
        }

        place_answer(input, true);
    </script>
</body>

</html>